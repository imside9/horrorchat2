<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기억의 늪: 심연 (Full Ver.)</title>
    <style>
        :root {
            --bg-color: #080808;
            --chat-bg: #111;
            --my-msg-bg: #2e4e3e; /* 톤다운된 초록색 */
            --other-msg-bg: #222;
            --system-msg-bg: #1a1a1a;
            --accent: #b71c1c; /* 피색 */
            --text-main: #dcdcdc;
            --font: 'Noto Sans KR', monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font);
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        #game-frame {
            width: 100%;
            max-width: 480px;
            background-color: var(--chat-bg);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
        }

        /* 헤더 */
        header {
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 15, 15, 0.95);
            z-index: 10;
        }
        .room-title { font-weight: bold; font-size: 0.95rem; letter-spacing: -0.5px; }
        .user-count { font-size: 0.8rem; color: #666; transition: color 0.3s; }
        .user-count.alert { color: var(--accent); animation: blink 1s infinite; }

        /* 채팅 영역 */
        #chat-window {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
            padding-bottom: 60px;
        }

        .msg {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.92rem;
            line-height: 1.5;
            word-break: break-all;
            opacity: 0;
            animation: fadeIn 0.4s forwards;
            position: relative;
        }

        .msg-left { align-self: flex-start; background: var(--other-msg-bg); border-top-left-radius: 2px; }
        .msg-right { align-self: flex-end; background: var(--my-msg-bg); color: #fff; border-top-right-radius: 2px; }
        .msg-system { 
            align-self: center; 
            background: none; 
            color: #777; 
            font-size: 0.75rem; 
            text-align: center;
            padding: 5px 10px;
            border: 1px solid #333;
            border-radius: 4px;
            margin: 15px 0;
            width: fit-content;
        }

        .sender { font-size: 0.7rem; color: #888; margin-bottom: 4px; display: block; }

        /* 타이핑 인디케이터 (입력중...) */
        .typing-indicator {
            align-self: flex-start;
            background: var(--other-msg-bg);
            padding: 10px 15px;
            border-radius: 12px;
            display: none; /* JS로 제어 */
            gap: 5px;
        }
        .dot { width: 6px; height: 6px; background: #666; border-radius: 50%; animation: bounce 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        /* 증거물 스타일 */
        .evidence-box {
            background: #000;
            border: 1px solid #444;
            padding: 12px;
            border-radius: 8px;
            margin-top: 5px;
        }
        .evidence-img {
            width: 100%;
            height: 140px;
            background: #151515;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            font-size: 0.8rem;
            border: 1px dashed #444;
            margin-bottom: 8px;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
        }

        /* 하단 인터랙션 영역 */
        #interaction-area {
            background: #0f0f0f;
            border-top: 1px solid #333;
            padding: 15px;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* 버튼 */
        .btn-choice {
            width: 100%;
            background: #252525;
            border: 1px solid #444;
            color: #ccc;
            padding: 14px;
            margin-bottom: 8px;
            border-radius: 6px;
            text-align: left;
            cursor: pointer;
            font-size: 0.95rem;
            transition: 0.2s;
        }
        .btn-choice:hover { background: #333; color: white; border-color: #666; }

        /* 입력창 */
        .input-group { display: flex; gap: 8px; }
        #answer-input {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #555;
            color: #fff;
            padding: 12px;
            border-radius: 4px;
            font-family: var(--font);
        }
        #submit-btn {
            background: #444;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        #submit-btn:hover { background: var(--accent); }

        /* 애니메이션 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .glitch-text { color: var(--accent); font-family: 'Courier New', monospace; font-weight: bold; }

    </style>
</head>
<body>

<div id="game-frame">
    <header>
        <span class="room-title">동창회 (준비위원회)</span>
        <span class="user-count" id="header-count">4명</span>
    </header>
    
    <div id="chat-window">
        <div class="typing-indicator" id="typing-indicator">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
    </div>

    <div id="interaction-area">
        <!-- JS로 동적 생성 -->
    </div>
</div>

<script>
    /* * [기획자님을 위한 수정 가이드]
     * 시나리오가 길어져서 'Act 1, 2, 3'으로 주석을 달아두었습니다.
     * correctAnswer 값을 바꿔서 퀴즈 정답을 변경할 수 있습니다.
     */
    
    const scenario = {
        // --- [Act 1: 초대의 공포] ---
        "start": {
            type: "system",
            text: "'알 수 없는 사용자'님이 당신, 김영훈(A), 박지수(B)님을 초대했습니다.",
            next: "act1_1"
        },
        "act1_1": {
            speaker: "민수",
            text: "얘들아, 진짜 오랜만이다. 다들 잘 지냈어?",
            next: "act1_2"
        },
        "act1_2": {
            speaker: "김영훈(A)",
            text: "누구세요? 잘못 초대하신 것 같은데요.",
            next: "act1_3"
        },
        "act1_3": {
            speaker: "박지수(B)",
            text: "...민수? 설마 박민수야?",
            next: "act1_choice"
        },
        "act1_choice": {
            type: "choice",
            text: "3년 전 실종된 친구의 이름이다. 손에 땀이 난다.",
            options: [
                { label: "민수야? 너 살아있었어?", next: "act1_react_good" },
                { label: "누구야 너. 고인 모독하지 마.", next: "act1_react_bad" }
            ]
        },
        "act1_react_good": {
            speaker: "민수",
            text: "살아있었냐니. 난 계속 여기 있었어. 너희들이 날 두고 간 곳에.",
            next: "act1_4"
        },
        "act1_react_bad": {
            speaker: "민수",
            text: "고인? 시체도 못 찾았는데 벌써 죽은 사람 취급이네. 섭섭하게.",
            next: "act1_4"
        },
        "act1_4": {
            speaker: "김영훈(A)",
            text: "야, 기분 나빠. 나 나갈게. 다들 나가자.",
            next: "act1_system_fail"
        },
        "act1_system_fail": {
            type: "system",
            text: "[경고] 김영훈(A)님이 대화방 나가기를 시도했으나 실패했습니다.",
            effect: "shake",
            next: "act1_5"
        },
        "act1_5": {
            speaker: "민수",
            text: "영훈아, 넌 못 나가. 내 돈 500만원 아직 안 갚았잖아.",
            next: "act1_6"
        },
        "act1_6": {
            speaker: "김영훈(A)",
            text: "뭐? 무슨 소리야! 난 빌린 적 없어!",
            next: "act1_evidence_A"
        },
        "act1_evidence_A": {
            type: "evidence",
            speaker: "민수",
            title: "[차용증 사진.jpg]",
            desc: "3년 전 날짜가 찍힌 자필 차용증. '돈을 갚지 못하면 낚시터 지분을 넘긴다'는 내용이 있다.",
            text: "이거 봐. 너 낚시터 가기 싫다고 했지? 사실은 내 지분 뺏으려고 억지로 끌고 간 거잖아.",
            next: "act1_A_gone"
        },
        "act1_A_gone": {
            type: "system",
            text: "김영훈(A)님의 연결이 끊겼습니다.",
            count: "3명",
            next: "act1_7"
        },
        
        // --- [Act 2: 고립과 의심] ---
        "act1_7": {
            speaker: "박지수(B)",
            text: "야... 이거 뭐야? 영훈이 진짜 나간 거야? 전화도 안 받아.",
            next: "act2_1"
        },
        "act2_1": {
            speaker: "민수",
            text: "거짓말쟁이는 퇴장시켰어. 이제 우리끼리 얘기하자 지수야.",
            next: "act2_2"
        },
        "act2_2": {
            speaker: "박지수(B)",
            text: "민수야 난 아니야! 난 너 찾으려고 경찰에도 신고했었어!",
            next: "act2_choice"
        },
        "act2_choice": {
            type: "choice",
            text: "지수가 울먹이며 나에게 동의를 구한다.",
            options: [
                { label: "맞아, 지수는 끝까지 널 찾았어.", next: "act2_lie" },
                { label: "(침묵한다)", next: "act2_silence" }
            ]
        },
        "act2_lie": {
            speaker: "민수",
            text: "찾았다고? 경찰이 아니라 네 남자친구한테 먼저 전화했잖아.",
            next: "act2_evidence_B"
        },
        "act2_silence": {
            speaker: "민수",
            text: "그래, 넌 알고 있었지? 지수가 그날 밤 누구랑 통화했는지.",
            next: "act2_evidence_B"
        },
        "act2_evidence_B": {
            type: "evidence",
            speaker: "민수",
            title: "[통화 녹음 파일.mp3]",
            desc: "재생 중: \"오빠, 민수 없어졌어. 어떡해? 알리바이 만들어줘. 우리 그냥 펜션에만 있었다고 해.\"",
            text: "지수야, 넌 내가 걱정된 게 아니라 네 불륜 들킬까 봐 걱정했잖아.",
            next: "act2_B_scream"
        },
        "act2_B_scream": {
            speaker: "박지수(B)",
            text: "아냐.. 아냐!!! 잘못했어 민수야!!!",
            next: "act2_B_gone"
        },
        "act2_B_gone": {
            type: "system",
            text: "박지수(B)님이 대화방에서 강제 퇴장당했습니다.",
            count: "2명",
            effect: "shake",
            next: "act3_intro"
        },

        // --- [Act 3: 독대와 퀴즈] ---
        "act3_intro": {
            speaker: "민수",
            text: "이제 우리 둘만 남았네. 방해꾼들도 사라졌고.",
            next: "act3_1"
        },
        "act3_1": {
            speaker: "민수",
            text: "너는 다르지? 넌 내 베프였잖아. 기억하지?",
            next: "puzzle_1_intro"
        },
        "puzzle_1_intro": {
            type: "chat",
            speaker: "민수",
            text: "내가 너한테 보낸 마지막 파일이 있어. 잠겨있는데, 비밀번호가 우리 처음 만난 날짜야.\n(힌트: 2002년 월드컵 때 우리가 처음 만났잖아. 월/일 4자리)",
            next: "puzzle_1_input"
        },
        "puzzle_1_input": {
            type: "input",
            speaker: "System",
            text: "비밀번호 4자리를 입력하세요. (힌트: 06??)",
            correctAnswer: "0622",
            next: "puzzle_1_correct",
            failNext: "puzzle_1_fail"
        },
        "puzzle_1_fail": {
            speaker: "민수",
            text: "와... 이걸 까먹어? 넌 친구도 아니야.",
            next: "game_over_bad"
        },
        "puzzle_1_correct": {
            speaker: "System",
            text: "[잠금 해제 성공] 파일명: '그날의 진실.mov'",
            next: "act3_2"
        },
        "act3_2": {
            speaker: "민수",
            text: "역시 넌 기억하고 있구나. 그럼 그 장소도 기억하겠네.",
            next: "puzzle_2_intro"
        },
        "puzzle_2_intro": {
            speaker: "민수",
            text: "비 내리던 낚시터. 내가 죽어가던 그 방갈로 호수 번호.",
            next: "puzzle_2_input"
        },
        "puzzle_2_input": {
            type: "input",
            speaker: "System",
            text: "방갈로 호수를 입력하세요. (힌트: 죽을 사(4)자가 겹치는 불길한 숫자)",
            correctAnswer: "444",
            next: "puzzle_2_correct",
            failNext: "puzzle_2_fail"
        },
        "puzzle_2_fail": {
            speaker: "민수",
            text: "기억 안 난다고? 네가 예약했잖아!!!",
            next: "game_over_bad"
        },
        "puzzle_2_correct": {
            speaker: "민수",
            text: "444호. 맞아. 거기서 네가 날 밀었지.",
            next: "climax_evidence"
        },
        "climax_evidence": {
            type: "evidence",
            speaker: "System",
            title: "[CCTV 영상 재생]",
            desc: "흔들리는 화면 속, 당신의 손목시계가 보인다. 당신의 손이 민수의 등을 호수 쪽으로 강하게 민다.",
            text: "영상 속 남자는 울면서 민수를 밀어버리고 있다.",
            next: "final_choice"
        },
        "final_choice": {
            type: "choice",
            text: "민수가 채팅방에 내 현재 위치(집 주소)를 띄웠다. 선택해야 한다.",
            options: [
                { label: "미안해... 내가 죽였어. 자수할게.", next: "ending_true" },
                { label: "이건 조작이야! 난 안 죽였어!", next: "ending_madness" }
            ]
        },

        // --- [엔딩] ---
        "game_over_bad": {
            type: "ending",
            text: "[BAD ENDING: 실종]\n당신은 민수의 질문에 대답하지 못했고, 그 후로 아무도 당신을 보지 못했습니다."
        },
        "ending_true": {
            type: "ending",
            text: "[TRUE ENDING: 참회]\n경찰서 위치가 전송되었습니다. 민수의 프로필 사진이 웃는 얼굴로 바뀌었습니다."
        },
        "ending_madness": {
            type: "ending",
            text: "[HIDDEN ENDING: 망상]\n채팅방 인원이 99명으로 늘어납니다. 모든 참여자가 당신의 이름을 부르고 있습니다."
        }
    };

    // [게임 엔진]
    const chatWindow = document.getElementById('chat-window');
    const interactionArea = document.getElementById('interaction-area');
    const headerCount = document.getElementById('header-count');
    const typingIndicator = document.getElementById('typing-indicator');

    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

    // 민수가 입력중... 효과
    async function showTyping() {
        typingIndicator.style.display = 'flex';
        chatWindow.scrollTop = chatWindow.scrollHeight;
        await wait(1500); // 1.5초 동안 입력중 표시
        typingIndicator.style.display = 'none';
    }

    async function addMessage(data) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('msg');

        if (data.type === 'system' || data.type === 'ending') {
            msgDiv.classList.add('msg-system');
            msgDiv.innerText = data.text;
        } else if (data.type === 'evidence') {
            msgDiv.classList.add('msg-left');
            msgDiv.innerHTML = `
                <span class="sender">${data.speaker}</span>
                <div class="evidence-box">
                    <div class="evidence-img">${data.desc}</div>
                    <div style="color:#ccc;">${data.text}</div>
                </div>`;
        } else {
            // 화자가 '나'가 아니면 입력중 효과 보여주기
            if (data.speaker !== '나' && data.speaker && !data.speaker.includes('System')) {
                await showTyping();
            }
            
            if (data.speaker && data.speaker.includes('나')) {
                msgDiv.classList.add('msg-right');
                msgDiv.innerText = data.text;
            } else {
                msgDiv.classList.add('msg-left');
                msgDiv.innerHTML = `<span class="sender">${data.speaker}</span>${data.text}`;
            }
        }

        chatWindow.insertBefore(msgDiv, typingIndicator); // 입력중 표시보다 위에 메시지 추가
        chatWindow.scrollTop = chatWindow.scrollHeight;
        
        // 효과 처리
        if (data.effect === 'shake') {
            document.getElementById('game-frame').classList.add('shake');
            setTimeout(() => document.getElementById('game-frame').classList.remove('shake'), 500);
        }
        if (data.count) {
            headerCount.innerText = data.count;
            headerCount.classList.add('alert');
        }

        await wait(600);
    }

    async function playScene(sceneId) {
        const data = scenario[sceneId];
        if (!data) return;

        // 텍스트 출력
        if (data.text && !data.options && data.type !== 'choice' && data.type !== 'input') {
            await addMessage(data);
        }

        // 엔딩 처리
        if (data.type === 'ending') {
            await addMessage(data);
            interactionArea.innerHTML = "<div style='color:#666; text-align:center;'>게임 종료 (새로고침)</div>";
            return;
        }

        // 입력 UI 생성
        interactionArea.innerHTML = '';

        if (data.type === 'choice') {
            if(data.text) await addMessage({speaker: 'System', text: data.text, type: 'system'});
            
            data.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'btn-choice';
                btn.innerText = opt.label;
                btn.onclick = () => {
                    addMessage({speaker: '나(Protagonist)', text: opt.label, type: 'chat'});
                    playScene(opt.next);
                };
                interactionArea.appendChild(btn);
            });

        } else if (data.type === 'input') {
            await addMessage(data); // 퀴즈 질문

            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';
            inputGroup.innerHTML = `
                <input type="text" id="answer-input" placeholder="답변 입력..." autocomplete="off">
                <button id="submit-btn">전송</button>
            `;
            interactionArea.appendChild(inputGroup);

            const input = inputGroup.querySelector('#answer-input');
            const btn = inputGroup.querySelector('#submit-btn');

            const checkAnswer = () => {
                const val = input.value.trim();
                if (!val) return;
                
                addMessage({speaker: '나(Protagonist)', text: val, type: 'chat'});
                
                // 정답 체크 (대소문자/공백 무시)
                if (val.replace(/\s/g, '') === data.correctAnswer) {
                    playScene(data.next);
                } else {
                    playScene(data.failNext);
                }
            };

            btn.onclick = checkAnswer;
            input.onkeypress = (e) => { if(e.key === 'Enter') checkAnswer(); };

        } else if (data.next) {
            playScene(data.next);
        }
    }

    // 게임 시작
    window.onload = () => {
        setTimeout(() => playScene('start'), 1000);
    };

</script>
</body>
</html>